---
import MainLayout from "../layouts/MainLayout.astro";
import Hero from "../components/sections/Hero.astro";
import About from "../components/sections/About.astro";
import Experience from "../components/sections/Experience.astro";
import Projects from "../components/sections/Projects.astro";
import Contact from "../components/sections/Contact.astro";
import Terminal from "../components/terminal/Terminal.astro";
---

<MainLayout
  title="Kvnfrr | Portfolio"
  description="Portfolio of Kevin Ferrer, a developer focused on cloud, DevOps, and full-stack development."
>
  <div class="content-shell">
    <Hero />
    <About />
    <Experience />
    <Projects />
    <Contact />
  </div>
  <Terminal data-deferred />

  <script>
    const TYPE_DURATION_MS = 950; // per line
    const LINE_DELAY_MS = 250;
    const DELAY_AFTER_TYPE_MS = 1000;

    const typewriter = document.querySelector("[data-typewriter]");
    const deferredItems = Array.from(document.querySelectorAll("[data-deferred]"));
    const terminalShell = document.querySelector("[data-terminal-shell]");
    const observedSections = Array.from(document.querySelectorAll("[data-observe]"));

    function revealDeferred() {
      deferredItems.forEach((el, index) => {
        const revealDelay = 80 * index;
        setTimeout(() => el.classList.add("is-visible"), revealDelay);
      });

      // Pop the terminal open shortly after the other content is visible.
      if (terminalShell) {
        setTimeout(() => document.dispatchEvent(new CustomEvent("kvn:open-terminal")), 350);
      }

      document.body.classList.remove("intro-active");
    }

    function runTypewriter() {
      if (!typewriter) {
        revealDeferred();
        return;
      }

      const text = typewriter.dataset.typewriterText?.trim() || typewriter.textContent?.trim();
      if (!text) {
        revealDeferred();
        return;
      }

      const lines = text.split("\n").map((line) => line.trim());
      const perLineDuration = TYPE_DURATION_MS;

      typewriter.textContent = "";
      typewriter.classList.add("is-typing");

      let currentLine = 0;

      const typeLine = () => {
        const line = lines[currentLine] ?? "";
        const perChar = Math.max(8, Math.floor(perLineDuration / Math.max(1, line.length)));
        let charIndex = 0;

        const timer = setInterval(() => {
          const typedPortion = line.slice(0, charIndex + 1);
          const previousLines = lines.slice(0, currentLine).join("\n");
          typewriter.textContent = previousLines
            ? `${previousLines}\n${typedPortion}`
            : typedPortion;

          charIndex += 1;

          if (charIndex >= line.length) {
            clearInterval(timer);
            if (currentLine < lines.length - 1) {
              currentLine += 1;
              setTimeout(typeLine, LINE_DELAY_MS);
            } else {
              typewriter.classList.remove("is-typing");
              setTimeout(revealDeferred, DELAY_AFTER_TYPE_MS);
            }
          }
        }, perChar);
      };

      typeLine();
    }

    function observeSections() {
      if (!observedSections.length) return;
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.25 }
      );

      observedSections.forEach((section) => observer.observe(section));
    }

    function startIntro() {
      document.body.classList.add("intro-active");
      runTypewriter();
      observeSections();
    }

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", startIntro);
    } else {
      startIntro();
    }
  </script>
</MainLayout>
