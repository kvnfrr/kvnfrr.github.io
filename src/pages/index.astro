---
import MainLayout from "../layouts/MainLayout.astro";
import Hero from "../components/sections/Hero.astro";
import About from "../components/sections/About.astro";
import Experience from "../components/sections/Experience.astro";
import Projects from "../components/sections/Projects.astro";
import Contact from "../components/sections/Contact.astro";
import Terminal from "../components/terminal/Terminal.astro";
---

<MainLayout
  title="Kvnfrr | Portfolio"
  description="Portfolio of Kevin Ferrer, a developer focused on cloud, DevOps, and full-stack development."
>
  <div class="content-shell">
    <Hero />
    <div class="post-hero">
      <div class="workspace" data-workspace>
        <div class="workspace-nav" data-workspace-nav>
          <button data-workspace-section="home">Home</button>
          <button data-workspace-section="about">About</button>
          <button data-workspace-section="experience">Experience</button>
          <button data-workspace-section="projects">Projects</button>
          <button data-workspace-section="contact">Contact</button>
        </div>
        <div class="workspace-list" data-workspace-list></div>
        <div class="workspace-detail" data-workspace-detail>
          <div class="workspace-detail-placeholder">Select something on the left to view details.</div>
        </div>
      </div>
    </div>
  </div>
  <Terminal data-deferred />

  <script>
    const TYPE_DURATION_MS = 950; // per line
    const LINE_DELAY_MS = 250;
    const DELAY_AFTER_TYPE_MS = 1000;

    const typewriter = document.querySelector("[data-typewriter]");
    const deferredItems = Array.from(document.querySelectorAll("[data-deferred]"));
    const terminalShell = document.querySelector("[data-terminal-shell]");
    const observedSections = Array.from(document.querySelectorAll("[data-observe]"));
    const workspace = document.querySelector("[data-workspace]");
    const workspaceNav = document.querySelector("[data-workspace-nav]");
    const workspaceList = document.querySelector("[data-workspace-list]");
    const workspaceDetail = document.querySelector("[data-workspace-detail]");

    const workspaceData = {
      home: {
        items: [
          {
            id: "welcome",
            title: "Welcome",
            subtitle: "Landing copy",
            body:
              "Quick scan of the opening pitch and how to navigate. The hero gives the vibe; the terminal is for the curious."
          }
        ]
      },
      about: {
        items: [
          {
            id: "bio",
            title: "Who I Am",
            subtitle: "Short bio",
            body:
              "Pragmatic engineer with a taste for automation and clean systems. Comfortable across cloud, DevOps, and full-stack."
          },
          {
            id: "approach",
            title: "Approach",
            subtitle: "How I work",
            body:
              "Ship iteratively, automate the boring, measure impact, and keep the DX humane. Humor optional but encouraged."
          }
        ]
      },
      experience: {
        items: [
          {
            id: "sre",
            title: "SRE / DevOps",
            subtitle: "Reliability focus",
            body: "Built and maintained CI/CD, observability, and infra-as-code for resilient services."
          },
          {
            id: "fullstack",
            title: "Full-stack Engineer",
            subtitle: "Product delivery",
            body: "Delivered user-facing features end-to-end, from APIs to polished UI with performant integrations."
          }
        ]
      },
      projects: {
        items: [
          {
            id: "terminal-site",
            title: "Terminal Portfolio",
            subtitle: "This site",
            body: "Interactive hero, terminal controls, and a playful take on portfolio UX."
          },
          {
            id: "infra-toolkit",
            title: "Infra Toolkit",
            subtitle: "Automation",
            body: "Scripted deployments, repeatable environments, and guardrails for teams."
          }
        ]
      },
      contact: {
        items: [
          {
            id: "reach",
            title: "Reach Out",
            subtitle: "Email / socials",
            body: "Drop a line at kevinferrercs@gmail.com or ping me for collaboration."
          }
        ]
      }
    };

    function revealDeferred() {
      deferredItems.forEach((el, index) => {
        const revealDelay = 80 * index;
        setTimeout(() => el.classList.add("is-visible"), revealDelay);
      });

      // Pop the terminal open shortly after the other content is visible.
      if (terminalShell) {
        setTimeout(() => document.dispatchEvent(new CustomEvent("kvn:open-terminal")), 350);
      }

      document.body.classList.remove("intro-active");
    }

    function runTypewriter() {
      if (!typewriter) {
        revealDeferred();
        return;
      }

      const text = typewriter.dataset.typewriterText?.trim() || typewriter.textContent?.trim();
      if (!text) {
        revealDeferred();
        return;
      }

      const lines = text.split("\n").map((line) => line.trim());
      const perLineDuration = TYPE_DURATION_MS;

      typewriter.textContent = "";
      typewriter.classList.add("is-typing");

      let currentLine = 0;

      const typeLine = () => {
        const line = lines[currentLine] ?? "";
        const perChar = Math.max(8, Math.floor(perLineDuration / Math.max(1, line.length)));
        let charIndex = 0;

        const timer = setInterval(() => {
          const typedPortion = line.slice(0, charIndex + 1);
          const previousLines = lines.slice(0, currentLine).join("\n");
          typewriter.textContent = previousLines
            ? `${previousLines}\n${typedPortion}`
            : typedPortion;

          charIndex += 1;

          if (charIndex >= line.length) {
            clearInterval(timer);
            if (currentLine < lines.length - 1) {
              currentLine += 1;
              setTimeout(typeLine, LINE_DELAY_MS);
            } else {
              typewriter.classList.remove("is-typing");
              setTimeout(revealDeferred, DELAY_AFTER_TYPE_MS);
            }
          }
        }, perChar);
      };

      typeLine();
    }

    function observeSections() {
      if (!observedSections.length) return;
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.25 }
      );

      observedSections.forEach((section) => observer.observe(section));
    }

    function renderWorkspace(sectionKey) {
      if (!workspace || !workspaceList || !workspaceDetail) return;
      const data = workspaceData[sectionKey];
      if (!data) return;

      workspaceList.innerHTML = "";
      data.items.forEach((item, index) => {
        const button = document.createElement("button");
        button.className = "workspace-list-item";
        button.dataset.workspaceItem = item.id;
        button.innerHTML = `
          <span class="workspace-item-title">${item.title}</span>
          <span class="workspace-item-sub">${item.subtitle ?? ""}</span>
        `;
        if (index === 0) button.classList.add("is-active");
        button.addEventListener("click", () => renderWorkspaceDetail(sectionKey, item.id));
        workspaceList.appendChild(button);
      });

      renderWorkspaceDetail(sectionKey, data.items[0]?.id);
    }

    function renderWorkspaceDetail(sectionKey, itemId) {
      const data = workspaceData[sectionKey];
      if (!data || !workspaceDetail) return;
      const item = data.items.find((i) => i.id === itemId);
      if (!item) return;

      workspaceDetail.classList.remove("is-changing");
      // Trigger reflow to restart animation
      void workspaceDetail.offsetWidth;
      workspaceDetail.classList.add("is-changing");

      const buttons = workspaceList?.querySelectorAll("[data-workspace-item]") ?? [];
      buttons.forEach((btn) => {
        btn.classList.toggle("is-active", btn.dataset.workspaceItem === itemId);
      });

      workspaceDetail.innerHTML = `
        <div class="workspace-detail-meta">
          <p class="workspace-detail-date">Selection: ${item.subtitle ?? "Detail"}</p>
        </div>
        <h3 class="workspace-detail-title">${item.title}</h3>
        <p class="workspace-detail-body">${item.body}</p>
      `;
    }

    function initWorkspace() {
      if (!workspace || !workspaceNav) return;
      const navButtons = workspaceNav.querySelectorAll("[data-workspace-section]");
      navButtons.forEach((button) => {
        button.addEventListener("click", () => {
          navButtons.forEach((b) => b.classList.remove("is-active"));
          button.classList.add("is-active");
          renderWorkspace(button.dataset.workspaceSection);
        });
      });

      const defaultSection = navButtons[0]?.dataset.workspaceSection ?? "home";
      const defaultButton = Array.from(navButtons).find((btn) => btn.dataset.workspaceSection === defaultSection);
      defaultButton?.classList.add("is-active");
      renderWorkspace(defaultSection);
      workspace.classList.add("is-ready");
    }

    function startIntro() {
      document.body.classList.add("intro-active");
      runTypewriter();
      observeSections();
      initWorkspace();
    }

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", startIntro);
    } else {
      startIntro();
    }
  </script>
</MainLayout>
