---
const { class: passedClass = "", ...rest } = Astro.props;
---

<section
  class={`command-station ${passedClass}`.trim()}
  data-terminal-shell
  data-terminal-state="collapsed"
  {...rest}
>
  <div class="shell-inner">
    <div class="terminal-panel">
      <header class="terminal-header">
        <p class="terminal-title">guest@kvnfrr:~</p>
      </header>

      <div class="terminal-body">
        <div class="terminal-log" data-terminal-log>
          <div class="terminal-line">
            Welcome to kvnfrr.sh - portfolio shell.
          </div>
          <div class="terminal-line">
            Type "help" to view available commands.
          </div>
        </div>
        <div class="terminal-input-row">
          <span class="prompt">guest@portfolio:~$</span>
          <input
            data-terminal-input
            type="text"
            name="command"
            autocomplete="off"
            placeholder="Try: hero - clear - minimize - help - open linkedin"
          />
          <button
            class="btn primary small"
            type="button"
            data-action="run-command"
          >
            Run
          </button>
        </div>
      </div>
    </div>

    <div class="dock-bar">
      <div class="dock-left">
        <span class="dock-label">Quick jump</span>
        <div class="dock-nav">
          <button type="button" data-nav="hero" aria-label="Go to hero section"
            >Home</button
          >
          <button
            type="button"
            data-nav="about"
            aria-label="Go to about section">About</button
          >
          <button
            type="button"
            data-nav="experience"
            aria-label="Go to experience section"
          >
            Experience
          </button>
          <button
            type="button"
            data-nav="projects"
            aria-label="Go to projects section"
          >
            Projects
          </button>
          <button
            type="button"
            data-nav="contact"
            aria-label="Go to contact section"
          >
            Contact
          </button>
        </div>
      </div>
      <div class="dock-right">
        <span class="dock-label muted">Terminal</span>
        <button
          class="dock-toggle switch-toggle"
          type="button"
          data-action="toggle-terminal"
        >
          <span class="switch-track" aria-hidden="true">
            <span class="switch-thumb"></span>
          </span>
          <span class="switch-label">Open / Hide</span>
        </button>
      </div>
    </div>
  </div>
</section>

<script>
  // @ts-nocheck

  (function initTerminal() {
    function setup() {
      const shell = document.querySelector("[data-terminal-shell]");
      if (!shell) return;

      const log = shell.querySelector("[data-terminal-log]");
      const input = shell.querySelector("[data-terminal-input]");
      const runButton = shell.querySelector("[data-action='run-command']");
      const toggleButton = shell.querySelector(
        "[data-action='toggle-terminal']"
      );
      const minimizeButton = shell.querySelector(
        "[data-action='minimize-terminal']"
      );
      const navButtons = shell.querySelectorAll("[data-nav]") || [];

      const LINKS = {
        linkedin: "https://linkedin.com/in/kevinferrercs",
        github: "https://github.com/kvnfrr",
        resume: "/Kevin_s_Resume.pdf",
        handshake: "https://fiu.joinhandshake.com/profiles/kvnfrr",
        email: "mailto:kevinferrercs@gmail.com",
      };

      const defaultLines = [
        "Welcome to kvnfrr.sh - portfolio shell.",
        "Seasoned dev? You can navigate this site from here.",
        'Type "help" to view available commands.',
        "Hints: hero - clear - minimize - help - open linkedin",
      ];

      function printLine(text, type = "output") {
        if (!log) return;
        const line = document.createElement("div");
        line.className = "terminal-line " + type;
        line.textContent = text;
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
      }

      function setState(state) {
        shell.dataset.terminalState = state;
        if (state === "open" && input) {
          setTimeout(() => input.focus(), 60);
        }
      }

      function goToHero() {
        const hero = document.getElementById("hero");
        if (!hero) return;
        window.scrollTo({
          top: hero.offsetTop - 72,
          behavior: "smooth",
        });
      }

      function openWorkspaceSection(section) {
        document.dispatchEvent(
          new CustomEvent("kvn:open-workspace-section", {
            detail: { section },
          })
        );
      }

      const commands = {
        help() {
          printLine("Available commands:");
          printLine("- hero");
          printLine("- clear");
          printLine("- minimize");
          printLine("- open <linkedin|github|resume|handshake|email>");
          printLine("- help");
        },
        hero() {
          goToHero();
          return "Jumping to hero...";
        },
        clear() {
          if (log) log.innerHTML = "";
          return "Cleared buffer.";
        },
        minimize() {
          setState("collapsed");
          return "Terminal hidden. Use the dock to reopen.";
        },
      };

      function handleCommand(raw) {
        if (!raw) return;
        const command = raw.trim().toLowerCase();
        if (!command) return;

        printLine("guest@kvnfrr:~$ " + command, "input");

        const parts = command.split(/\s+/);
        const cmd = parts[0];
        const arg = parts.length > 1 ? parts[1] : null;

        if (cmd === "open") {
          if (!arg) {
            setState("open");
            printLine("Terminal expanded.");
            return;
          }

          if (LINKS && LINKS[arg]) {
            window.open(LINKS[arg], "_blank", "noopener");
            printLine("Opening " + arg + "...");
            return;
          }

          printLine(
            "Don't know how to open \"" +
              arg +
              '". Try: linkedin, github, resume, handshake, email.'
          );
          return;
        }

        const action = commands[cmd];
        if (action) {
          const response = action();
          if (Array.isArray(response)) {
            response.forEach((line) => printLine(line));
          } else if (response) {
            printLine(response);
          }
        } else {
          printLine("Command not found: " + cmd + '. Try "help".');
        }
      }

      if (log) {
        log.innerHTML = "";
        defaultLines.forEach((line) => printLine(line));
      }

      if (input) {
        input.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            handleCommand(input.value);
            input.value = "";
          }
        });
      }

      if (runButton) {
        runButton.addEventListener("click", () => {
          if (!input) return;
          handleCommand(input.value);
          input.value = "";
        });
      }

      if (toggleButton) {
        toggleButton.addEventListener("click", () => {
          const state =
            shell.dataset.terminalState === "open" ? "collapsed" : "open";
          setState(state);
        });
      }

      if (minimizeButton) {
        minimizeButton.addEventListener("click", () => setState("collapsed"));
      }

      navButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const target = button.dataset.nav;
          if (!target) return;
          if (target === "hero") {
            goToHero();
          } else {
            openWorkspaceSection(target);
          }
        });
      });

      document.addEventListener("kvn:open-terminal", () => setState("open"));
    }

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", setup);
    } else {
      setup();
    }
  })();
</script>
