---
const { class: passedClass = "", ...rest } = Astro.props;
---

<section
  class={`command-station ${passedClass}`.trim()}
  data-terminal-shell
  data-terminal-state="collapsed"
  {...rest}
>
  <div class="shell-inner">
    <div class="terminal-panel">
      <header class="terminal-header">
        <p class="terminal-title">guest@kvnfrr:~</p>
      </header>

      <div class="terminal-body">
        <div class="terminal-log" data-terminal-log>
          <div class="terminal-line">Welcome to kvnfrr.sh - portfolio shell.</div>
          <div class="terminal-line">Type "help" to view available commands.</div>
        </div>
        <div class="terminal-input-row">
          <span class="prompt">guest@portfolio:~$</span>
          <input
            data-terminal-input
            type="text"
            name="command"
            autocomplete="off"
            placeholder="Try: hero - clear - minimize - help"
          />
          <button class="btn primary small" type="button" data-action="run-command">Run</button>
        </div>
      </div>
    </div>

    <div class="dock-bar">
      <div class="dock-left">
        <span class="dock-label">Quick jump</span>
        <div class="dock-nav">
          <button type="button" data-nav="hero" aria-label="Go to hero section">Home</button>
          <button type="button" data-nav="about" aria-label="Go to about section">About</button>
          <button type="button" data-nav="experience" aria-label="Go to experience section">
            Experience
          </button>
          <button type="button" data-nav="projects" aria-label="Go to projects section">
            Projects
          </button>
          <button type="button" data-nav="contact" aria-label="Go to contact section">Contact</button>
        </div>
      </div>
      <div class="dock-right">
        <span class="dock-label muted">Terminal</span>
        <button class="dock-toggle switch-toggle" type="button" data-action="toggle-terminal">
          <span class="switch-track" aria-hidden="true">
            <span class="switch-thumb"></span>
          </span>
          <span class="switch-label">Open / Hide</span>
        </button>
      </div>
    </div>
  </div>
</section>

<script>
// @ts-nocheck
const shell = document.querySelector("[data-terminal-shell]");
const log = shell?.querySelector("[data-terminal-log]");
const input = shell?.querySelector("[data-terminal-input]");
const runButton = shell?.querySelector("[data-action='run-command']");
const toggleButton = shell?.querySelector("[data-action='toggle-terminal']");
const minimizeButton = shell?.querySelector("[data-action='minimize-terminal']");
const navButtons = shell?.querySelectorAll("[data-nav]") ?? [];

const defaultLines = [
  "Welcome to kvnfrr.sh - portfolio shell.",
  "Seasoned dev? You can navigate this site from here.",
  'Type "help" to view available commands.',
  "Hints: hero - clear - minimize"
];

function printLine(text, type = "output") {
  if (!log) return;
  const line = document.createElement("div");
  line.className = `terminal-line ${type}`;
  line.textContent = text;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
}

function setState(state) {
  if (!shell) return;
  shell.dataset.terminalState = state;
  if (state === "open") {
    setTimeout(() => input?.focus(), 60);
  }
}

function scrollToSection(id) {
  const target = document.getElementById(id);
  if (target) {
    window.scrollTo({
      top: target.offsetTop - 72,
      behavior: "smooth"
    });
  }
}

const commands = {
  help: () => {
    printLine("Available commands:");
    ["hero", "clear", "minimize", "open"].forEach((cmd) => printLine(`- ${cmd}`));
  },
  hero: () => {
    scrollToSection("hero");
    return "Jumping to hero...";
  },
  clear: () => {
    if (log) log.innerHTML = "";
    return "Cleared buffer.";
  },
  minimize: () => {
    setState("collapsed");
    return "Terminal hidden. Use the dock to reopen.";
  },
  open: () => {
    setState("open");
    return "Terminal expanded.";
  }
};

function handleCommand(raw) {
  if (!raw) return;
  const command = raw.trim();
  if (!command) return;

  printLine(`guest@kvnfrr:~$ ${command}`, "input");

  const action = commands[command.toLowerCase()];
  if (action) {
    const response = action();
    if (Array.isArray(response)) {
      response.forEach((line) => printLine(line));
    } else if (response) {
      printLine(response);
    }
  } else {
    printLine(`Command not found: ${command}. Try "help".`);
  }
}

if (log) {
  log.innerHTML = "";
  defaultLines.forEach((line) => printLine(line));
}

input?.addEventListener("keydown", (event) => {
  if (event.key === "Enter") {
    event.preventDefault();
    handleCommand(input.value);
    input.value = "";
  }
});

runButton?.addEventListener("click", () => {
  if (!input) return;
  handleCommand(input.value);
  input.value = "";
});

toggleButton?.addEventListener("click", () => {
  if (!shell) return;
  const state = shell.dataset.terminalState === "open" ? "collapsed" : "open";
  setState(state);
});

minimizeButton?.addEventListener("click", () => setState("collapsed"));

navButtons.forEach((button) => {
  button.addEventListener("click", () => scrollToSection(button.dataset.nav));
});

document.addEventListener("kvn:open-terminal", () => setState("open"));

</script>
